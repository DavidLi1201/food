$(document).ready(
  function() {
    //获取保存的顾客信息
    var guke = JSON.parse(localStorage.getItem("guke"));
    if (guke) {
      $(".seat-id").html(guke.seatId);
      $(".seat-desc").html(guke.seatDesc);
      $(".seat-gk").html(guke.gkName + "/" + guke.gkPhone);
      $(".gk-bz").html(guke.gkBz);
    }
    //获取点菜详情
    var dataFood = [];
    var hasOrder = 0; //判断客户是否选择了菜单

    for (var i = localStorage.length - 1; i >= 0; i--) {
      var s = localStorage.key(i);
      if (s.substring(0, 5) == "foods") {
        var food = JSON.parse(localStorage.getItem(localStorage.key(i)));
        dataFood.push(food);
      }
    }
    if (dataFood.length == 0) {
      hasOrder = 0;
    } else if (dataFood.length != 0) {
      hasOrder = 1;
    }
    var list = MyApp.templates.buynow(dataFood);
    $("#select-list").html(list);

    var total = 0;
    var totalNum = 0;

    $(".selected-list").each(function() {
      var money = parseInt($(this).attr("data-money"));
      var num = parseInt($(this).attr("data-num"));
      total += money;
      totalNum += num;
    });
    $("#money").html(total);
    $("#total-num").html(totalNum);

    $("body").on("tap", ".delect", function() {
      var dataId = $(this).attr("data-id");
      $(this).parent().parent().remove();
      localStorage.removeItem("foods" + dataId);
    });
    $(".goodsName").each(function() {
      $(this).tap(function() {
        $(this).siblings(".edit").toggle();
      });
    });
    $(".selected-list").each(function() {
      var num = parseInt($(this).find(".num").html());
      var price = parseInt($(this).attr("data-price"));
      var that = $(this);
      $(this).find(".cut-num").tap(function() {
        if (num == "1") {
          $("body").append("<div class='tip'>已经不能再少了</div>");
          setTimeout(function() {
            $(".tip").remove();
          }, 4000);
        } else if (num > 1) {
          num -= 1;
          that.find(".num").html(num);
          that.attr({
            "data-num": num
          });
          var all = num * price;
          that.attr({
            "data-money": price
          });
          calTotal();
        }
      });
      $(this).find(".add-num").tap(function() {
        num += 1;
        that.find(".num").html(num);
        that.attr({
          "data-num": num
        });
        var all = num * price;
        that.attr({
          "data-money": all
        });
        calTotal();
      });

    });
    //立即预订按钮
    $("#order-now").tap(function() {
      //保存最新购物车信息到session
      if (!guke) {
        alert("请先选座！");
        return;
      }
      var orderid = localStorage.getItem("orderid");
      if( orderid ){
        alert("您已经有一份订单了！");
        return;
      }
      saveBuy();
      $("body").append("<div class='tip'>正在加载中，请稍后</div>");
      setTimeout(function() {
        $(".tip").remove();
      }, 4000);
      var url = "http://www.wlx.com/food/App/checkSeat";
      var id = $(".seat-id").html();
      $.ajax({
        type: 'post',
        url: url,
        data: {
          "id": id,
        },
        success: function(data) {
          var data = JSON.parse(data)
          if (data.info == "ok") {
            //把顾客信息保存到数据库
            saveGk();
          }
          else {
            $(".mask").show();
            $("#seat-result").show();
          }
        },
        error: function() {

        }
      });
    });
    $("body").on("tap", "#no", function() {
      $(".mask").hide();
      $("#seat-result").hide();
    });
    $("body").on("tap", "#ok", function() {
      $(".mask").hide();
      $("#seat-result").hide();
      localStorage.removeItem("guke");
      window.location.href = "seat.html";
    });
    $("body").on("tap", ".close-btn", function() {
      $(".mask").hide();
      $(".pupop").hide();
      $("#seat-popup").hide();
    });

    function saveGk() {
      $.ajax({
        type: 'post',
        url: "http://www.wlx.com/food/App/orderSeat",
        data: {
          "seatid": guke.seatId,
          "gkname": guke.gkName,
          "gkphone": guke.gkPhone,
          "gkbz": guke.gkBz,
          "orderid": hasOrder,
        },
        success: function(data) {
          var data = JSON.parse(data);
          if (data.status == "1") {
            var orderSeatId = data.info;
            if (hasOrder) {
              saveOrder(orderSeatId);
            } else {
              $("body").append("<div class='tip'>预订成功,您的订座编号为：" + data.info + "</div>");
              setTimeout(function() {
                $(".tip").remove();
              }, 2000);
            }

          } else {
            $("body").append("<div class='tip'>预订失败</div>");
            setTimeout(function() {
              $(".tip").remove();
            }, 2000);
          }
        },
        error: function() {
          $("body").append("<div class='tip'>预订失败</div>");
          setTimeout(function() {
            $(".tip").remove();
          }, 2000);
        }
      });
    }

    function calTotal() {
      var allNum = 0;
      var allMoney = 0;
      $(".selected-list").each(function() {
        var num = parseInt($(this).attr("data-num"));
        var money = parseInt($(this).attr("data-money"));
        allNum += num;
        allMoney += money;
      })
      $("#money").html(allMoney);
      $("#total-num").html(allNum);
    }

    function saveBuy() {
      $(".selected-list").each(function() {
        var num = parseInt($(this).attr("data-num"));
        var money = parseInt($(this).attr("data-money"));
        var price = parseInt($(this).attr("data-price"));
        var id = parseInt($(this).attr("data-id"));
        var name = $(this).attr("data-name");
        var bz = $(this).find(".remark").find("input").val();
        var foodsid = "foods" + id;
        var foods = {
          "id": id,
          "num": num,
          "price": price,
          "money": money,
          "name": name,
          "bz": bz,
        }
        localStorage.setItem(foodsid, JSON.stringify(foods));
      })
    };

    function saveOrder(seatid) {
      var seatid = seatid;
      var saveData = [];
      for (var i = localStorage.length - 1; i >= 0; i--) {
        var s = localStorage.key(i);
        if (s.substring(0, 5) == "foods") {
          var food = localStorage.getItem(localStorage.key(i));
          saveData.push(food);
        }
      };
      $.ajax({
        type: 'post',
        url: "http://www.wlx.com/food/App/order",
        data: {
          saveData,
          "orderseat": seatid,
        },
        success: function(data) {
          var data = JSON.parse(data);
          if (data.status == "1") {
            $("body").append("<div class='tip'>预订成功</div>");
            setTimeout(function() {
              $(".tip").remove();
            }, 2000);
            localStorage.setItem("orderid", data.info);
            window.location.href = "myOrder.html";
          } else {
            $("body").append("<div class='tip'>预订失败</div>");
            setTimeout(function() {
              $(".tip").remove();
            }, 2000);
          }
        },
        error: function() {
          $("body").append("<div class='tip'>预订失败</div>");
          setTimeout(function() {
            $(".tip").remove();
          }, 2000);
        }
      });
    }
  })
